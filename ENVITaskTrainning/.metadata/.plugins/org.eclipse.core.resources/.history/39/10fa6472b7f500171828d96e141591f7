; Add the extension to the toolbox. Called automatically on ENVI startup.
pro Water_extensions_init

  ; Set compile options
  compile_opt IDL2

  ; Get ENVI session
  e = ENVI(/CURRENT)

  ; Add the extension to a subfolder
  e.AddExtension, 'Water', 'Water', PATH=''
end

; ENVI Extension code. Called when the toolbox item is chosen.
pro Water

  ; Set compile options
  compile_opt IDL2

  ; General error handler
  CATCH, err
  if (err ne 0) then begin
    CATCH, /CANCEL
    if OBJ_VALID(e) then $
      e.ReportError, 'ERROR: ' + !error_state.msg
    MESSAGE, /RESET
    return
  endif

  ;Get ENVI session
  e = ENVI(/CURRENT)

  ;******************************************
  ; Insert your ENVI Extension code here...
  ;******************************************
  
  task = ENVITask('WaterExtraction')
  ui=e.UI
  r=ui.SelectTaskParameters(task)
  ;执行自定义ENVITask
  IF r NE 'OK' THEN return
  task.Execute
  
  ;显示结果
  dataCol = e.DATA
  view = e.GetView()
  layer = view.Createlayer(task.OUTPUT_RASTER)
  dataCol.Add, task.OUTPUT_RASTER
  dataCol.Add, task.OUTPUT_VECTOR
  layer = view.Createlayer(task.OUTPUT_VECTOR)
end
