# Landsat 9 随机森林监督分类与变化检测

## 处理结果展示

<div align="center">

<img src="https://raw.githubusercontent.com/fashionfu/ENVI_IDL/main/%E5%AD%A6%E4%B9%A0%E8%BF%87%E7%A8%8B/1113_%E5%9B%BE%E5%83%8F%E7%BB%93%E6%9E%9C.png" alt="分类与变化检测结果" width="1600">

**图1：2021年随机森林监督分类结果** | **图2：2025年随机森林监督分类结果** | **图3：地面控制点校正后2025年结果** | **图4：变化差值图**

<sub>*从左至右依次展示了分类处理流程的三个关键步骤：原始分类结果、配准校正和最终的变化检测结果*</sub>

</div>

---

## 程序概述

**程序名**: `landsat9_classification.pro`  
**功能**: 对2021和2025年Landsat 9数据进行随机森林监督分类，包括平滑和聚合后处理，去除小斑点，并进行多时相分类结果对比分析  
**输入**: ROI文件、光谱指数结果（NDVI、NDWI、NDBI）  
**输出**: 分类结果（保存到results文件夹）、变化检测结果

---

## 工作流程

### 1. 数据预处理阶段

#### 1.1 地面控制点配准（手动操作，在ENVI Classic中完成）

**重要说明**：在进行分类之前，需要先进行精确的地理配准，这是确保后续差值运算准确性的关键步骤。
**ENVI Classic地理配准可参考**：https://zhuanlan.zhihu.com/p/394275164

**操作流程**：
1. 以2021年的监督分类结果作为基础影像（参考影像）
2. 为2021年和2025年影像添加地面控制点（GCP）
3. 对2025年影像进行Warp配准，使其与2021年影像精确对齐
4. 保存配准后的2025年影像为 `classification_2025_warp.dat`

**为什么需要GCP配准？**

仅使用MTL XML文件中的空间参考坐标系和四角坐标值进行差值运算，精度往往不够准确，主要原因包括：

1. **系统级几何校正的局限性**
   - Landsat数据虽然经过了系统级几何校正，但仍存在残留误差：
     - 传感器畸变（镜头畸变、CCD阵列不齐等）
     - 平台姿态变化（卫星姿态变化、轨道漂移）
     - 地形影响（高程变化导致的投影偏移）
     - 大气折射（大气层对光线的折射）
     - 地球曲率（大范围影像的曲率影响）
   - MTL XML中的参数是理论值，无法完全消除这些误差

2. **GCP配准 vs 仅设置投影参数**

   **仅设置投影参数（从MTL XML提取）**：
   - 只设置整体投影框架
   - 不进行像素级重采样
   - 无法校正局部几何畸变
   - 两个影像的局部误差会累积

   **GCP配准（ENVI Classic方法）**：
   - 使用多个地面控制点进行精确配准
   - 建立局部变换模型（多项式、RST、三角网等）
   - 进行像素级重采样
   - 校正局部几何畸变
   - 确保两个影像在像素级对齐

3. **差值运算对配准精度的要求**
   - 差值运算需要像素级对齐：同一地物必须在同一像素位置
   - 对偏移非常敏感：1-2个像素的偏移会导致显著误差
   - 分类结果更敏感：分类影像的类别值对配准误差更敏感

**结论**：GCP配准通过控制点和重采样实现像素级对齐，因此比仅设置投影参数更准确。

### 2. 自动分类处理阶段（代码执行）

#### 2.1 数据加载与预处理

**主要功能**：
- 自动查找并打开Landsat 9 MTL文件
- 支持多种数据集格式（Multispectral、Surface Reflectance等）
- 如果MTL方式失败，自动尝试直接打开TIF波段文件
- 自动检测并添加空间参考信息（从MTL XML文件）

**关键函数**：
- `create_spatial_ref_from_mtl_xml()`: 从MTL XML文件读取投影参数并创建空间参考
- `add_spatial_ref_to_raster_file()`: 为缺少空间参考的影像添加空间参考信息
- `set_spatial_ref_to_raster()`: 为raster设置空间参考

#### 2.2 光谱指数计算

**计算的光谱指数**：
- **NDVI** (归一化植被指数): `(NIR - Red) / (NIR + Red)`
- **NDWI** (归一化水体指数): `(Green - SWIR1) / (Green + SWIR1)`
- **NDBI** (归一化建筑指数): `(SWIR1 - NIR) / (SWIR1 + NIR)`

**波段对应关系**（Landsat 9 Surface Reflectance）：
- B1 = Blue (索引0)
- B2 = Green (索引1)
- B3 = Red (索引2)
- B4 = NIR (索引3)
- B5 = SWIR1 (索引4)
- B6 = SWIR2 (索引5)
- B7 = 其他 (索引6)

**处理逻辑**：
- 如果光谱指数文件已存在，直接加载
- 如果不存在，自动计算并保存
- 将原始波段与光谱指数合并为堆叠影像

#### 2.3 随机森林分类

**分类参数**：
- 算法：随机森林（Random Forest）
- 树数量：100
- 输入：原始波段 + NDVI + NDWI + NDBI（或仅原始波段）
- 训练样本：从ROI文件中加载

**输出文件**：
- `classification_2021.dat` - 2021年分类结果
- `classification_2025_warp.dat` - 2025年配准后的分类结果（由用户手动配准后提供）

#### 2.4 分类后处理

**处理步骤**：

1. **分类平滑**（ClassificationSmoothing）
   - 使用5×5核进行平滑
   - 去除分类噪声

2. **分类聚合**（ClassificationAggregation）
   - 去除小斑点
   - 使用三种方法（按优先级）：
     - 方法1：基于像素面积计算的最小聚合大小（通常>9像素）
     - 方法2：使用更小的聚合阈值（MINIMUM_SIZE=5）
     - 方法3：跳过聚合，直接使用平滑结果
   - 自动验证数据有效性，选择最佳方法

3. **元数据更新**
   - 设置类别数量
   - 设置类别名称
   - 设置颜色查找表（植被=绿色，水体=蓝色，其他=灰色）

**输出文件**：
- `classification_2021_final.dat` - 2021年后处理结果（如果执行分类）
- `classification_2025_final.dat` - 2025年后处理结果（如果执行分类）

### 3. 对比分析阶段

#### 3.1 读取配准后的分类结果

**输入文件**（用户已配准）：
- `classification_2021.dat` - 2021年基础分类结果
- `classification_2025_warp.dat` - 2025年配准后的分类结果

#### 3.2 空间参考信息检查与添加

**处理逻辑**：
- 检查两个分类结果是否都有空间参考信息
- 如果缺少，从MTL XML文件自动添加
- **注意**：2025年配准后的影像使用2021年的空间参考信息（因为已配准到2021年基础影像）

#### 3.3 影像对齐（ImageIntersection）

**功能**：
- 使用 `ImageIntersection` 任务进行地理坐标对齐
- 确保两个影像在像素级精确对齐
- 处理可能的尺寸不一致问题

**输出文件**：
- `classification_2021_aligned.dat` - 对齐后的2021年分类结果
- `classification_2025_aligned.dat` - 对齐后的2025年分类结果

#### 3.4 变化检测计算

**变化编码方法**：
- 公式：`changeCode = (class2021 * 10) + class2025`
- 编码示例：
  - 11 = 植被到植被（无变化）
  - 12 = 植被到水体（变化）
  - 21 = 水体到植被（变化）
  - 等等

**计算步骤**：
1. 堆叠两个对齐后的分类结果
2. 使用 `PixelwiseBandMathRaster` 计算变化编码
3. 生成变化检测影像
4. 计算变化矩阵和统计信息

**输出文件**：
- `change_detection_2021_2025.dat` - 变化检测结果

#### 3.5 变化统计与分析

**统计内容**：
- 变化矩阵（像素数）：显示各类别之间的转换情况
- 各类别面积变化：
  - 2021年面积
  - 2025年面积
  - 变化量（像素数和百分比）

**输出格式**：
```
变化矩阵（2021年 → 2025年）:
  行=2021年类别，列=2025年类别
  类别: 植被, 水体, 其他

各类别面积变化:
  植被:
    2021年: XXXX 像素
    2025年: XXXX 像素
    变化: XXXX 像素 (XX.XX%)
```

---

## 代码结构

### 主要函数

1. **`extract_xml_tag_value()`**
   - 从XML文件中提取标签值（通用函数）

2. **`create_spatial_ref_from_mtl_xml()`**
   - 从MTL XML文件读取投影参数并创建空间参考
   - 提取：UTM带、基准面、像素大小、左上角坐标

3. **`set_spatial_ref_to_raster()`**
   - 为raster设置空间参考（通过导出和重新导入）

4. **`add_spatial_ref_to_raster_file()`**
   - 为缺少空间参考的影像添加空间参考信息
   - 直接从文件头修改

5. **`process_classification_postprocessing()`**
   - 分类后处理（平滑、聚合、元数据更新）
   - 支持多种聚合方法，自动选择最佳方法

6. **`process_year_classification()`**
   - 处理单一年份的分类
   - 包括：数据加载、光谱指数计算、分类、后处理

7. **`landsat9_classification()`**
   - 主程序
   - 处理2021和2025年数据
   - 执行对比分析

### 关键配置参数

**数据路径**：
```idl
dataPath2021 = 'E:\1021WaterData\LC09\LC09_L2SP_121043_20211206_20230505_02_T1'
dataPath2025 = 'E:\1021WaterData\LC09\LC09_L2SP_121043_20250827_20250828_02_T1'
```

**ROI文件**：
```idl
roiFile2021 = 'E:\1021WaterData\LC09\LC09_L2SP_121043_20211206_20230505_02_T1\1110.xml'
roiFile2025 = 'E:\1021WaterData\LC09\LC09_L2SP_121043_20211206_20230505_02_T1\1111.xml'
```

**输出目录**：
```idl
outputDir = 'E:\1021WaterData\LC09\LC09_L2SP_121043_20211206_20230505_02_T1\results_fenkuaidaima'
```

**分类参数**：
- 随机森林树数量：100
- 平滑核大小：5×5
- 聚合最小面积：基于像素面积计算（通常>9像素）

---

## 输出文件说明

### 分类结果文件

1. **`classification_2021.dat`**
   - 2021年随机森林分类结果（基础影像）
   - 用于作为配准参考

2. **`classification_2025_warp.dat`**
   - 2025年配准后的分类结果
   - 由用户在ENVI Classic中通过GCP配准生成

3. **`classification_2021_final.dat`**
   - 2021年后处理结果（如果执行分类）
   - 包含平滑和聚合处理

4. **`classification_2025_final.dat`**
   - 2025年后处理结果（如果执行分类）
   - 包含平滑和聚合处理

### 对齐和变化检测文件

5. **`classification_2021_aligned.dat`**
   - 对齐后的2021年分类结果
   - 通过ImageIntersection任务生成

6. **`classification_2025_aligned.dat`**
   - 对齐后的2025年分类结果
   - 通过ImageIntersection任务生成

7. **`change_detection_2021_2025.dat`**
   - 变化检测结果
   - 每个像素值表示从2021年到2025年的类别变化编码

### 光谱指数文件（中间文件）

8. **`ndvi_2021.dat`**, **`ndvi_2025.dat`**
   - NDVI计算结果

9. **`ndwi_2021.dat`**, **`ndwi_2025.dat`**
   - NDWI计算结果

10. **`ndbi_2021.dat`**, **`ndbi_2025.dat`**
    - NDBI计算结果

---

## 使用注意事项

### 1. 配准要求

**必须**在运行代码之前完成GCP配准：
- 以2021年分类结果为参考影像
- 对2025年影像进行Warp配准
- 保存为 `classification_2025_warp.dat`

### 2. 文件路径

确保以下文件存在：
- MTL文件（`*_MTL.txt` 和 `*_MTL.xml`）
- ROI文件（`.xml`格式）
- 配准后的2025年分类结果（`classification_2025_warp.dat`）

### 3. 空间参考信息

- 代码会自动检测并添加缺失的空间参考信息
- 2025年配准后的影像使用2021年的空间参考信息

### 4. 内存和性能

- 分类过程可能需要10-30分钟
- 确保有足够的磁盘空间存储中间文件和结果
- 大影像可能需要较长处理时间

---

## 技术要点总结

### 1. 为什么GCP配准比仅设置投影参数更准确？

**核心原因**：
- **像素级对齐**：GCP配准通过重采样确保像素级对齐，而仅设置投影参数只能保证整体框架正确
- **局部误差校正**：GCP配准可以校正局部几何畸变，而投影参数无法处理局部误差
- **差值运算精度要求**：差值运算需要亚像素级精度，GCP配准可以满足这一要求

### 2. 代码中的对齐机制

代码使用 `ImageIntersection` 任务进行二次对齐：
- 即使已经GCP配准，仍可能存在微小偏移
- `ImageIntersection` 确保两个影像在像素级完全对齐
- 这是差值运算准确性的双重保障

### 3. 变化检测编码方法

使用 `class2021 * 10 + class2025` 编码：
- 优点：简单直观，易于解析
- 限制：最多支持10个类别（0-9）
- 对于更多类别，需要修改编码方法

---

## 改进建议

### 1. 自动化配准

可以考虑在代码中集成自动配准功能：
- 使用 `ImageRegistration` 任务进行自动配准
- 或使用 `WarpFromGCPs` 任务基于控制点配准

### 2. 变化检测编码优化

对于更多类别的情况：
- 使用 `class2021 * 100 + class2025`（支持100个类别）
- 或使用多波段编码方法

### 3. 精度评估

可以添加：
- 配准精度评估（RMSE）
- 分类精度评估（混淆矩阵、Kappa系数）
- 变化检测精度评估

---

## 总结

本程序实现了Landsat 9数据的完整分类和变化检测流程：

1. **预处理**：用户手动进行GCP配准（关键步骤）
2. **分类**：自动进行随机森林分类和后处理
3. **对齐**：自动进行影像对齐
4. **变化检测**：自动计算变化矩阵和统计信息

**关键成功因素**：
- GCP配准确保了像素级对齐精度
- 代码的自动对齐机制提供了双重保障
- 完整的后处理流程提高了分类质量

通过这一流程，可以准确地进行多时相分类结果对比和变化检测分析。







