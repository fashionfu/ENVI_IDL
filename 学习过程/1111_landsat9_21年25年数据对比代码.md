# Landsat 9 数据2021年与2025年对比分析代码流程与处理指导

## 分类结果可视化对比

<table>
<tr>
<td width="50%">

![2021年分类结果](https://raw.githubusercontent.com/fashionfu/ENVI_IDL/main/%E5%AD%A6%E4%B9%A0%E8%BF%87%E7%A8%8B/1111_21%E5%B9%B4%E6%95%B0%E6%8D%AE.png)

*图1：2021年Landsat 9数据随机森林分类结果（植被=绿色，水体=蓝色，其他=灰色）*

</td>
<td width="50%">

![2025年分类结果](https://raw.githubusercontent.com/fashionfu/ENVI_IDL/main/%E5%AD%A6%E4%B9%A0%E8%BF%87%E7%A8%8B/1111_25%E5%B9%B4%E6%95%B0%E6%8D%AE.png)

*图2：2025年Landsat 9数据随机森林分类结果（植被=绿色，水体=蓝色，其他=灰色）*

</td>
</tr>
</table>

**对比分析**：
- 从图中可以明显看出，2021年到2025年期间，植被覆盖面积显著减少（从54.98%降至13.79%）
- 其他地类（主要是裸土和建筑用地）面积大幅增加（从12.21%增至53.57%）
- 水体面积基本保持稳定（从32.80%降至32.64%，变化仅0.16%）
- 这一变化趋势与统计数据分析结果一致，反映了该区域土地利用/覆盖的显著变化

**注意**：造成这种显著变化的主要原因是2025年的数据存在大面积的云量覆盖，同时2021年的ROI训练样本数据质量较差，这些因素影响了分类结果的准确性。在实际应用中，建议使用云量较少的高质量影像数据，并确保训练样本的代表性和准确性。

---

## 一、程序概述

### 1.1 程序功能
本程序（`1111_影像监督分类结果后处理.pro`）实现了基于NDVI和NDBI的Landsat 9 (LC09)数据随机森林监督分类与时间序列变化分析，主要功能包括：

1. **光谱指数计算**：计算NDVI（归一化植被指数）和NDBI（归一化建筑指数）
2. **监督分类**：使用随机森林算法进行监督分类（植被、水体、其他）
3. **时间序列对比**：2021年与2025年参数对比分析
4. **变化检测**：植被退化、水体变化分析

### 1.2 技术特点
- **分类方法**：随机森林（Random Forest）监督分类
- **决策树数量**：100棵
- **后处理**：分类平滑（5×5核）和分类聚合
- **输出格式**：ENVI格式（.dat + .hdr）

---

## 二、代码结构

### 2.1 主要函数模块

#### 2.1.1 辅助函数
1. **`create_spatial_ref_from_mtl_xml`**
   - 功能：从MTL XML文件读取投影参数并创建空间参考
   - 提取参数：UTM Zone、左上角坐标、像元大小
   - 返回：MAP_INFO结构体

2. **`set_spatial_ref_to_raster`**
   - 功能：为raster设置空间参考信息
   - 处理：导出到临时文件 → 设置空间参考 → 重新打开并保留波长信息

3. **`process_classification_postprocessing`**
   - 功能：分类后处理（平滑、聚合、元数据更新）
   - 步骤：
     - 数据验证
     - 分类平滑（Kernel Size=5）
     - 分类聚合（三种方法：原始参数、小阈值、仅平滑）
     - 元数据更新（类别名称、颜色查找表）

4. **`log_write` / `log_error`**
   - 功能：日志记录系统
   - 使用COMMON块共享日志文件句柄

#### 2.1.2 主程序
**`test1110_finalndvi`**：主处理流程

---

## 三、完整处理流程

### 3.1 初始化阶段

#### 步骤1：日志系统初始化
```idl
logFile = 'E:\1027IDL\ENVITaskTrainning\02_ENVITasks\test1110_finalndvi.log'
OPENW, logLun, logFile, /GET_LUN, /APPEND
```
- 创建日志文件，记录所有处理步骤
- 使用COMMON块共享日志句柄

#### 步骤2：启动ENVI
```idl
e = ENVI(/CURRENT)
IF ~OBJ_VALID(e) THEN e = ENVI()
```
- 检查ENVI是否已启动，如未启动则启动ENVI

#### 步骤3：设置数据路径
- **2021年数据路径**：`E:\1021WaterData\LC09\LC09_L2SP_121043_20211206_20230505_02_T1`
- **2025年数据路径**：`E:\1021WaterData\LC09\LC09_L2SP_121043_20250827_20250828_02_T1`
- **ROI文件**：
  - 2021年：`1110.xml`
  - 2025年：`1111.xml`
- **输出目录**：`{数据路径}\results`

---

### 3.2 2021年数据处理

#### 步骤1：打开数据
程序尝试三种方法打开Landsat 9数据：

**方法1**：使用DATASET_NAME参数
```idl
raster2021 = e.OpenRaster(mtlFile2021, DATASET_NAME='Surface Reflectance')
```

**方法2**：使用ExtractRasterFromFileTask
```idl
extractTask = ENVITask('ExtractRasterFromFile')
extractTask.INPUT_URI = mtlFile2021
extractTask.DATASET_NAME = 'Surface Reflectance'
extractTask.Execute
```

**方法3**：默认方式打开（返回数组）
```idl
rasters2021 = e.OpenRaster(mtlFile2021)
raster2021 = rasters2021[0]
```

#### 步骤2：空间参考处理
如果打开的数据没有空间参考信息：
1. 从MTL XML文件读取投影参数
2. 创建MAP_INFO结构体
3. 为raster设置空间参考

**关键参数**：
- UTM Zone: 50
- Datum: WGS-84
- 像元大小: 30米
- 左上角坐标：从XML文件提取

#### 步骤3：计算光谱指数
```idl
ndvi2021 = ENVISpectralIndexRaster(raster2021, 'NDVI')
ndbi2021 = ENVISpectralIndexRaster(raster2021, 'NDBI')
```

#### 步骤4：合并波段
```idl
buildStackTask2021 = ENVITask('BuildLayerStack')
buildStackTask2021.INPUT_RASTERS = [raster2021, ndvi2021, ndbi2021]
buildStackTask2021.Execute
stackedRaster2021 = buildStackTask2021.OUTPUT_RASTER
```
- 总波段数：7（原始）+ 1（NDVI）+ 1（NDBI）= 9个波段

---

### 3.3 2025年数据处理（如果存在）

处理流程与2021年相同：
1. 打开数据（三种方法）
2. 空间参考处理
3. 计算NDVI和NDBI
4. 合并波段

---

### 3.4 随机森林监督分类

#### 步骤1：加载ROI
```idl
rois = e.OpenROI(roiFile2021)
```
- 2021年ROI：`1110.xml`（植被1110、水体1110、其他1110）
- 2025年ROI：`1111.xml`（植被1111、水体1111、其他1111）

#### 步骤2：创建分类任务
```idl
rfTask2021 = ENVITask('RandomForestClassification')
rfTask2021.input_raster = stackedRaster2021
rfTask2021.input_rois = rois
rfTask2021.numberOfTrees = 100  ; 决策树数量
rfTask2021.output_raster_uri = outputClass2021
rfTask2021.showMsg = 0  ; 禁用对话框
rfTask2021.display = 0  ; 禁用自动显示
```

#### 步骤3：执行分类
```idl
rfTask2021.Execute
```
- **执行时间**：约5-7分钟（7681×7821像素，9波段，100棵树）
- **输出类型**：uint8（1字节/像素）

#### 步骤4：验证结果
- 检查输出文件大小
- 验证文件完整性（期望大小 = 像素数 × 1字节）
- 获取分类结果对象

#### 步骤5：更新元数据
设置分类结果的元数据：
- **classes**：类别数量（nClasses + 1，包含未分类）
- **class names**：类别名称数组
- **class lookup**：颜色查找表（3×N数组，RGB值）
  - 植被：绿色 [0, 255, 0]
  - 水体：蓝色 [0, 0, 255]
  - 其他：灰色 [128, 128, 128]

---

### 3.5 分类后处理

#### 步骤1：数据验证
- 检查输入数据值是否在合理范围内
- 验证数据完整性

#### 步骤2：分类平滑
```idl
smoothTask = ENVITask('ClassificationSmoothing')
smoothTask.INPUT_RASTER = classifiedRaster
smoothTask.KERNEL_SIZE = 5
smoothTask.Execute
```
- 使用5×5核进行平滑处理
- 去除分类噪声

#### 步骤3：分类聚合
程序尝试三种方法（按优先级）：

**方法1**：使用原始聚合参数
```idl
aggregateTask1 = ENVITask('ClassificationAggregation')
aggregateTask1.INPUT_RASTER = smoothRaster
aggregateTask1.MINIMUM_SIZE = aggregateSize  ; 基于空间参考计算
aggregateTask1.Execute
```
- `aggregateSize`：根据空间参考计算（最小面积0.01 km²）

**方法2**：使用更小的聚合阈值
```idl
aggregateTask2.MINIMUM_SIZE = 5
```

**方法3**：跳过聚合，直接使用平滑结果

#### 步骤4：更新元数据
- 设置类别名称
- 设置颜色查找表
- 写入元数据到文件

---

### 3.6 分类统计计算

#### 步骤1：计算直方图
```idl
histTask2021 = ENVITask('RasterHistogram')
histTask2021.INPUT_RASTER = finalRaster2021
histTask2021.INPUT_MIN = [1]
histTask2021.INPUT_MAX = [nClasses]
histTask2021.INPUT_NBINS = [nClasses]
histTask2021.Execute
counts2021 = (histTask2021.OUTPUT_COUNTS).ToArray()
```

#### 步骤2：计算面积
```idl
pixelArea = PRODUCT(spatialRef.PIXEL_SIZE) / 1E6  ; km²
areas2021 = counts2021 * pixelArea
```

#### 步骤3：输出统计信息
- 各类别面积（km²）
- 各类别百分比
- 各类别像元数

---

### 3.7 NDVI变化分析

#### 步骤1：计算NDVI统计信息
使用RasterHistogram计算统计值：
- 均值（MEAN）
- 标准差（STDDEV）
- 最小值（MIN）
- 最大值（MAX）

#### 步骤2：计算NDVI差值
```idl
ndviDiffTask = ENVITask('ImageBandDifference')
ndviDiffTask.INPUT_RASTER1 = ndvi2021_aligned
ndviDiffTask.INPUT_RASTER2 = ndvi2025_aligned
ndviDiffTask.Execute
ndviDiff = ndviDiffTask.OUTPUT_RASTER
```

#### 步骤3：分析变化趋势
- **负值**：NDVI降低（植被退化）
- **正值**：NDVI增加（植被改善）

---

### 3.8 分类变化检测

#### 步骤1：影像对齐
如果两个时相的分类结果尺寸不一致：
```idl
intersectTaskClass = ENVITask('ImageIntersection')
intersectTaskClass.INPUT_RASTER1 = raster2021_class
intersectTaskClass.INPUT_RASTER2 = raster2025_class
intersectTaskClass.Execute
```

#### 步骤2：计算变化矩阵
- 简化方法：通过面积变化估算变化矩阵
- 对角线元素：保持不变的像元数

#### 步骤3：保存对齐后的分类结果
用于后续空间分析

---

### 3.9 结果保存

#### 保存的文件
1. **分类结果**
   - `classification_2021.dat`：2021年原始分类结果
   - `classification_2021_final.dat`：2021年后处理分类结果
   - `classification_2025.dat`：2025年原始分类结果
   - `classification_2025_final.dat`：2025年后处理分类结果

2. **光谱指数**
   - `ndvi_2021.dat`：2021年NDVI
   - `ndbi_2021.dat`：2021年NDBI
   - `ndvi_2025.dat`：2025年NDVI
   - `ndbi_2025.dat`：2025年NDBI
   - `ndvi_diff_2021_2025.dat`：NDVI差值

3. **变化检测**
   - `classification_2021_aligned.dat`：对齐后的2021年分类
   - `classification_2025_aligned.dat`：对齐后的2025年分类
   - `change_detection_info.txt`：变化检测信息

4. **报告文件**
   - `analysis_report.txt`：统计分析报告
   - `test1110_finalndvi.log`：处理日志

---

## 四、关键参数说明

### 4.1 随机森林参数
- **numberOfTrees**：100（决策树数量）
- **输入波段**：9个（7个原始波段 + NDVI + NDBI）
- **输出类型**：uint8（类别值：1, 2, 3...）

### 4.2 后处理参数
- **平滑核大小**：5×5
- **聚合最小面积**：0.01 km²（基于空间参考计算）
- **聚合阈值**：11个像元（30m分辨率）

### 4.3 空间参考参数
- **投影系统**：UTM Zone 50N
- **基准面**：WGS-84
- **像元大小**：30米 × 30米
- **像元面积**：0.0009 km²

---

## 五、运行结果示例

### 5.1 2021年分类统计
```
植被1110:   29726.50 km² (54.98%, 33029446 像元)
水体1110:   17735.41 km² (32.80%, 19706011 像元)
其他1110:    6603.88 km² (12.21%,  7337644 像元)
总计:   54065.79 km²
```

### 5.2 2025年分类统计
```
植被1111:    7457.83 km² (13.79%,  8286473 像元)
水体1111:   17646.73 km² (32.64%, 19607481 像元)
其他1111:   28961.23 km² (53.57%, 32179147 像元)
总计:   54065.79 km²
```

### 5.3 变化分析
```
面积变化 (2025 - 2021):
  植被1110:  -22268.68 km² (-74.91%) [植被减少/退化]
  水体1110:     -88.68 km² ( -0.50%) [水体减少]
  其他1110:   22357.35 km² (338.55%)
```

### 5.4 NDVI变化
```
2021年NDVI: 均值=0.7004, 标准差=0.1856
2025年NDVI: 均值=0.7399, 标准差=0.2215
NDVI均值变化: 0.0396
结论: 植被整体呈改善趋势
```

---

## 六、使用指导

### 6.1 运行前准备

1. **数据准备**
   - 确保Landsat 9数据已下载并解压
   - 检查MTL.txt和MTL.xml文件存在
   - 准备ROI文件（在ENVI中标记训练样本并保存为XML格式）

2. **路径设置**
   - 修改代码中的数据路径（第1204、1213行）
   - 修改ROI文件路径（第1228、1229行）
   - 检查输出目录权限

3. **ENVI环境**
   - 确保ENVI已正确安装和授权
   - 检查ENVI版本兼容性（本代码适用于ENVI 5.x）

### 6.2 运行步骤

1. **编译代码**
   ```idl
   .compile 'E:\1027IDL\ENVITaskTrainning\02_ENVITasks\test1110_finalndvi.pro'
   ```

2. **运行程序**
   ```idl
   test1110_finalndvi
   ```

3. **监控进度**
   - 查看控制台输出
   - 检查日志文件：`test1110_finalndvi.log`
   - 预计总运行时间：15-20分钟（取决于数据大小）

### 6.3 结果查看

1. **在ENVI中打开**
   - 分类结果会自动添加到Data Manager
   - 使用分类颜色显示（植被=绿色，水体=蓝色，其他=灰色）

2. **查看统计报告**
   - 打开：`results\analysis_report.txt`
   - 包含详细的面积统计和变化分析

3. **查看日志**
   - 打开：`test1110_finalndvi.log`
   - 包含所有处理步骤和错误信息

---

## 七、常见问题与解决方案

### 7.1 空间参考缺失
**问题**：从MTL文件打开的数据没有空间参考信息

**解决方案**：
- 程序会自动从MTL XML文件读取投影参数
- 确保MTL.xml文件与MTL.txt在同一目录

### 7.2 导出失败
**问题**：`Unable to export raster. (Code: -5)`

**解决方案**：
- 程序会自动尝试使用ENVI的GetTemporaryFilename方法
- 检查临时文件目录权限：`E:\1027IDL\ENVITaskTrainning\Temp`

### 7.3 分类结果颜色不正确
**问题**：类别名称未识别，使用默认颜色

**解决方案**：
- 确保ROI名称包含关键词：植被、水体、其他
- 或修改代码中的类别名称匹配逻辑（第1060-1091行）

### 7.4 内存不足
**问题**：程序崩溃或执行缓慢

**解决方案**：
- 减少决策树数量（numberOfTrees）
- 裁剪输入数据为较小的区域
- 关闭其他占用内存的程序

### 7.5 文件被占用
**问题**：无法删除已存在的输出文件

**解决方案**：
- 关闭ENVI中打开的文件
- 手动删除文件后重新运行
- 检查文件是否被其他程序占用

---

## 八、代码优化建议

### 8.1 性能优化
1. **并行处理**：如果有多时相数据，可以考虑并行处理
2. **内存管理**：及时关闭不需要的raster对象
3. **文件I/O**：减少临时文件的创建和删除

### 8.2 功能扩展
1. **更多光谱指数**：可以添加EVI、SAVI等指数
2. **精度评估**：添加混淆矩阵和Kappa系数计算
3. **变化检测**：实现更精确的逐像元变化检测

### 8.3 代码改进
1. **参数化**：将硬编码的路径和参数提取为配置变量
2. **错误处理**：增强异常处理和错误恢复机制
3. **代码注释**：添加更详细的中文注释

---

## 九、技术要点总结

### 9.1 关键技术
1. **随机森林分类**：适用于多波段遥感数据分类
2. **空间参考处理**：从MTL XML文件提取投影信息
3. **分类后处理**：平滑和聚合提高分类质量
4. **时间序列分析**：多时相数据对比和变化检测

### 9.2 数据流程
```
原始数据 → 空间参考设置 → 光谱指数计算 → 波段合并 → 
随机森林分类 → 后处理（平滑+聚合） → 统计计算 → 
变化分析 → 结果保存
```

### 9.3 输出产品
1. **分类结果**：ENVI格式分类影像
2. **光谱指数**：NDVI、NDBI及其差值
3. **统计报告**：面积统计和变化分析
4. **变化矩阵**：分类变化转移矩阵

---

## 十、参考文献与资源

### 10.1 ENVI文档
- ENVI API Reference Guide
- ENVI Task Reference Guide
- Random Forest Classification Task

### 10.2 Landsat数据
- USGS Landsat Collection 2 Level-2 Science Products
- Landsat 9 OLI-2传感器参数

### 10.3 光谱指数
- NDVI: Normalized Difference Vegetation Index
- NDBI: Normalized Difference Built-up Index

---

## 附录：文件清单

### 输入文件
- `LC09_L2SP_121043_20211206_20230505_02_T1_MTL.txt`
- `LC09_L2SP_121043_20211206_20230505_02_T1_MTL.xml`
- `LC09_L2SP_121043_20250827_20250828_02_T1_MTL.txt`
- `LC09_L2SP_121043_20250827_20250828_02_T1_MTL.xml`
- `1110.xml`（2021年ROI）
- `1111.xml`（2025年ROI）

### 输出文件
- `classification_2021_final.dat` + `.hdr`
- `classification_2025_final.dat` + `.hdr`
- `ndvi_2021.dat` + `.hdr`
- `ndbi_2021.dat` + `.hdr`
- `ndvi_2025.dat` + `.hdr`
- `ndbi_2025.dat` + `.hdr`
- `ndvi_diff_2021_2025.dat` + `.hdr`
- `analysis_report.txt`
- `change_detection_info.txt`
- `test1110_finalndvi.log`

---

**文档版本**：1.0  
**最后更新**：2025年11月11日  
**作者**：Auto  
**适用版本**：ENVI 5.x, IDL 9.0

